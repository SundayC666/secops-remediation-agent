#!/usr/bin/env python3
# /// script
# requires-python = ">=3.9"
# dependencies = ["httpx>=0.28"]
# ///
"""
CISA KEV Check - Cross-reference CVE IDs against the CISA Known Exploited
Vulnerabilities catalog. Flags actively exploited vulnerabilities.
"""

import argparse
import json
import os
import sys
import tempfile
import time
from typing import Dict, List

import httpx

CISA_KEV_URL = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
CACHE_FILE = os.path.join(tempfile.gettempdir(), "cisa_kev_cache.json")
CACHE_TTL = 3600  # 1 hour


def load_kev_catalog() -> List[Dict]:
    """Load CISA KEV catalog, using cache if available and fresh."""
    # Check cache
    if os.path.exists(CACHE_FILE):
        cache_age = time.time() - os.path.getmtime(CACHE_FILE)
        if cache_age < CACHE_TTL:
            try:
                with open(CACHE_FILE, "r") as f:
                    data = json.load(f)
                    return data.get("vulnerabilities", [])
            except (json.JSONDecodeError, IOError):
                pass

    # Fetch fresh data
    try:
        with httpx.Client(timeout=15.0) as client:
            resp = client.get(CISA_KEV_URL)
            if resp.status_code == 200:
                data = resp.json()
                # Cache the response
                try:
                    with open(CACHE_FILE, "w") as f:
                        json.dump(data, f)
                except IOError:
                    pass
                return data.get("vulnerabilities", [])
            else:
                print(f"CISA KEV API error: {resp.status_code}", file=sys.stderr)
    except Exception as e:
        print(f"Failed to fetch CISA KEV: {e}", file=sys.stderr)

    return []


def check_kev(cve_ids: List[str]) -> Dict[str, Dict]:
    """Check CVE IDs against CISA KEV catalog."""
    catalog = load_kev_catalog()

    # Build lookup by CVE ID
    kev_lookup = {}
    for entry in catalog:
        kev_lookup[entry.get("cveID", "")] = entry

    results = {}
    for cve_id in cve_ids:
        cve_id = cve_id.strip().upper()
        if cve_id in kev_lookup:
            entry = kev_lookup[cve_id]
            results[cve_id] = {
                "is_kev": True,
                "date_added": entry.get("dateAdded", ""),
                "due_date": entry.get("dueDate", ""),
                "required_action": entry.get("requiredAction", ""),
                "vulnerability_name": entry.get("vulnerabilityName", ""),
                "vendor_project": entry.get("vendorProject", ""),
                "product": entry.get("product", ""),
                "known_ransomware_use": entry.get("knownRansomwareCampaignUse", "Unknown"),
            }
        else:
            results[cve_id] = {"is_kev": False}

    return results


def main():
    parser = argparse.ArgumentParser(description="Check CVE IDs against CISA KEV catalog")
    parser.add_argument(
        "--cve-ids",
        help="Comma-separated CVE IDs (e.g., CVE-2024-21351,CVE-2024-1234)",
    )
    args = parser.parse_args()

    # Read CVE IDs from argument or stdin
    if args.cve_ids:
        cve_ids = [cid.strip() for cid in args.cve_ids.split(",") if cid.strip()]
    else:
        cve_ids = [line.strip() for line in sys.stdin if line.strip()]

    if not cve_ids:
        print("No CVE IDs provided. Use --cve-ids or pipe IDs via stdin.", file=sys.stderr)
        sys.exit(1)

    results = check_kev(cve_ids)
    print(json.dumps(results, indent=2))


if __name__ == "__main__":
    main()
